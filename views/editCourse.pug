extends base

block content
  .container
    h1 Edit Course
    form#editCourseForm(method="POST" action=`/api/v1/courses/${course._id}?_method=PUT`)
      // Step 1
      .form-step#step1
        .form-group
          label(for="title") Course Title
          input#title.form-control(type="text" name="title" required value=course.title)
        .form-group
          label(for="description") Description
          textarea#description.form-control(name="description" rows="4" required)= course.description
        button.btn.btn-primary(type="button" id="nextBtn1") Next

      // Step 2
      .form-step#step2(style="display:none;")
        .form-group
          label(for="weeks") Duration (weeks)
          input#weeks.form-control(type="number" name="weeks" min="1" required value=course.weeks)
        .form-group
          label(for="tuition") Tuition Cost
          input#tuition.form-control(type="number" name="tuition" min="0" required value=course.tuition)
        button.btn.btn-secondary(type="button" id="prevBtn2") Previous
        button.btn.btn-primary(type="button" id="nextBtn2") Next

      // Step 3
      .form-step#step3(style="display:none;")
        .form-group
          label(for="minimumSkill") Minimum Skill Required
          select#minimumSkill.form-control(name="minimumSkill" required)
            option(value="beginner" selected=course.minimumSkill=='beginner') Beginner
            option(value="intermediate" selected=course.minimumSkill=='intermediate') Intermediate
            option(value="advanced" selected=course.minimumSkill=='advanced') Advanced
        .form-group
          label.checkbox-label
            input#scholarshipsAvailable(type="checkbox" name="scholarshipsAvailable" checked=course.scholarshipsAvailable)
            span Scholarships Available
        button.btn.btn-secondary(type="button" id="prevBtn3") Previous
        button.btn.btn-primary(type="button" id="nextBtn3") Next

      // Step 4 - Modules and Lessons
.form-step#step4(style="display:none;")
  #modules-container
    h3 Modules
    button.btn.btn-sm.btn-success(type="button" id="addModuleBtn") Add Module
    if course.modules && course.modules.length
      each module, moduleIndex in course.modules
        .module(data-module-id=module._id)
          h4 Module #{moduleIndex + 1}
          .form-group
            label Module Title
            input.form-control(
              type="text"
              name=`modules[${moduleIndex}][title]`
              value=module.title
              required
            )
          input(type="hidden" name=`modules[${moduleIndex}][_id]` value=module._id)
          
          .lessons-container
            if module.lessons && module.lessons.length
              each lesson, lessonIndex in module.lessons
                .lesson(data-lesson-id=lesson._id)
                  h5 Lesson #{lessonIndex + 1}
                  .form-group
                    label Lesson Title
                    input.form-control(
                      type="text"
                      name=`modules[${moduleIndex}][lessons][${lessonIndex}][title]`
                      value=lesson.title
                      required
                    )
                  .form-group
                    label Lesson Text
                    textarea.form-control(
                      name=`modules[${moduleIndex}][lessons][${lessonIndex}][text]`
                      rows="3"
                      required
                    )= lesson.text
                  .form-group
                    label Lesson Video URL
                    input.form-control(
                      type="text"
                      name=`modules[${moduleIndex}][lessons][${lessonIndex}][video]`
                      value=lesson.video
                      required
                    )
                  input(type="hidden" name=`modules[${moduleIndex}][lessons][${lessonIndex}][_id]` value=lesson._id)
                  button.btn.btn-danger.btn-sm.remove-lesson-btn(type="button") Remove Lesson
          
          button.btn.btn-primary.btn-sm.add-lesson-btn(type="button") Add Lesson
          button.btn.btn-danger.btn-sm.remove-module-btn(type="button") Remove Module

  script(src="/js/courseForm.js")
  script.
  document.addEventListener('DOMContentLoaded', () => {
    // Инициализация обработчиков для существующих модулей
    document.querySelectorAll('.module').forEach(module => {
      const lessonsContainer = module.querySelector('.lessons-container');
      const addLessonBtn = module.querySelector('.add-lesson-btn');
      const removeModuleBtn = module.querySelector('.remove-module-btn');
      const moduleId = module.dataset.moduleId;

      // Обработчик добавления урока
      addLessonBtn.addEventListener('click', () => {
        const lessonCount = lessonsContainer.querySelectorAll('.lesson').length;
        const newLesson = createLessonForm(moduleId, lessonCount, {});
        lessonsContainer.appendChild(newLesson);
      });

      // Обработчик удаления модуля
      removeModuleBtn.addEventListener('click', () => {
        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = `modules[${moduleId}][_delete]`;
        deleteInput.value = 'true';
        module.appendChild(deleteInput);
        module.style.display = 'none';
      });

      // Инициализация обработчиков для существующих уроков
      module.querySelectorAll('.lesson').forEach(lesson => {
        const removeLessonBtn = lesson.querySelector('.remove-lesson-btn');
        const lessonId = lesson.dataset.lessonId;
        
        removeLessonBtn.addEventListener('click', () => {
          const deleteInput = document.createElement('input');
          deleteInput.type = 'hidden';
          deleteInput.name = `modules[${moduleId}][lessons][${lessonId}][_delete]`;
          deleteInput.value = 'true';
          lesson.appendChild(deleteInput);
          lesson.style.display = 'none';
        });
      });
    });

    // Функция создания формы урока
    function createLessonForm(moduleId, lessonIndex, lessonData) {
      const lessonDiv = document.createElement('div');
      lessonDiv.classList.add('lesson');
      lessonDiv.innerHTML = `
        <h5>New Lesson</h5>
        <div class="form-group">
          <label>Lesson Title</label>
          <input type="text" 
                 name="modules[${moduleId}][lessons][${lessonIndex}][title]" 
                 class="form-control" 
                 required
                 value="${lessonData.title || ''}">
        </div>
        <div class="form-group">
          <label>Lesson Text</label>
          <textarea name="modules[${moduleId}][lessons][${lessonIndex}][text]" 
                    class="form-control" 
                    rows="3" 
                    required>${lessonData.text || ''}</textarea>
        </div>
        <div class="form-group">
          <label>Lesson Video URL</label>
          <input type="text" 
                 name="modules[${moduleId}][lessons][${lessonIndex}][video]" 
                 class="form-control" 
                 required
                 value="${lessonData.video || ''}">
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-lesson-btn">Remove Lesson</button>
      `;

      lessonDiv.querySelector('.remove-lesson-btn').addEventListener('click', function() {
        lessonDiv.remove();
      });

      return lessonDiv;
    }

    // Обработчик для кнопки добавления модуля
    document.getElementById('addModuleBtn')?.addEventListener('click', () => {
      const modulesContainer = document.getElementById('modules-container');
      const moduleCount = document.querySelectorAll('.module').length;
      const newModuleId = 'new_' + Date.now();
      
      const moduleDiv = document.createElement('div');
      moduleDiv.classList.add('module');
      moduleDiv.dataset.moduleId = newModuleId;
      
      moduleDiv.innerHTML = `
        <h4>New Module</h4>
        <div class="form-group">
          <label>Module Title</label>
          <input type="text" name="modules[${newModuleId}][title]" class="form-control" required>
        </div>
        <div class="lessons-container"></div>
        <button type="button" class="btn btn-primary btn-sm add-lesson-btn">Add Lesson</button>
        <button type="button" class="btn btn-danger btn-sm remove-module-btn">Remove Module</button>
      `;

      const lessonsContainer = moduleDiv.querySelector('.lessons-container');
      const addLessonBtn = moduleDiv.querySelector('.add-lesson-btn');
      const removeModuleBtn = moduleDiv.querySelector('.remove-module-btn');

      // Добавляем первый урок
      lessonsContainer.appendChild(createLessonForm(newModuleId, 0, {}));

      // Обработчики для нового модуля
      addLessonBtn.addEventListener('click', () => {
        const lessonCount = lessonsContainer.querySelectorAll('.lesson').length;
        lessonsContainer.appendChild(createLessonForm(newModuleId, lessonCount, {}));
      });

      removeModuleBtn.addEventListener('click', () => {
        moduleDiv.remove();
      });

      modulesContainer.insertBefore(moduleDiv, document.getElementById('addModuleBtn'));
    });
  });
